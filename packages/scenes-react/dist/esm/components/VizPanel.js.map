{"version":3,"file":"VizPanel.js","sources":["../../../src/components/VizPanel.tsx"],"sourcesContent":["import React, { useEffect, useId } from 'react';\nimport {\n  VizPanelMenu,\n  SceneDataProvider,\n  VizPanel as VizPanelObject,\n  VizPanelState,\n  VizConfig,\n  DataProviderProxy,\n  SceneDataNode,\n} from '@grafana/scenes';\nimport { usePrevious } from 'react-use';\nimport { getPanelOptionsWithDefaults } from '@grafana/data';\nimport { PanelContext } from '@grafana/ui';\nimport { writeSceneLog } from '../utils';\nimport { useSceneContext } from '../hooks/hooks';\n\nexport interface VizPanelProps {\n  title: string;\n  description?: string;\n  dataProvider?: SceneDataProvider;\n  viz: VizConfig;\n  displayMode?: 'default' | 'transparent';\n  hoverHeader?: boolean;\n  hoverHeaderOffset?: number;\n  menu?: VizPanelMenu;\n  titleItems?: React.ReactNode;\n  seriesLimit?: number;\n  seriesLimitShowAll?: boolean;\n  headerActions?: React.ReactNode;\n  extendPanelContext?: (vizPanel: VizPanelObject, context: PanelContext) => void;\n  collapsible?: boolean;\n  collapsed?: boolean;\n}\n\nexport function VizPanel(props: VizPanelProps) {\n  const {\n    title,\n    description,\n    viz,\n    dataProvider,\n    displayMode,\n    hoverHeader,\n    hoverHeaderOffset,\n    headerActions,\n    menu,\n    titleItems,\n    extendPanelContext,\n    seriesLimit,\n    seriesLimitShowAll,\n    collapsible,\n    collapsed,\n  } = props;\n\n  const scene = useSceneContext();\n  const key = useId();\n  const prevProps = usePrevious(props);\n\n  let panel = scene.findByKey<VizPanelObject>(key);\n\n  if (!panel) {\n    panel = new VizPanelObject({\n      key: key,\n      pluginId: viz.pluginId,\n      title: title,\n      titleItems: titleItems,\n      description: description,\n      options: viz.options,\n      fieldConfig: viz.fieldConfig,\n      pluginVersion: viz.pluginVersion,\n      $data: getDataProviderForVizPanel(dataProvider),\n      displayMode: displayMode,\n      hoverHeader: hoverHeader,\n      hoverHeaderOffset: hoverHeaderOffset,\n      headerActions: headerActions,\n      menu: menu,\n      extendPanelContext: extendPanelContext,\n      collapsible: collapsible,\n      collapsed: collapsed,\n      seriesLimit: seriesLimit,\n      seriesLimitShowAll: seriesLimitShowAll,\n    });\n  }\n\n  useEffect(() => scene.addToScene(panel), [panel, scene]);\n\n  // Update options\n  useEffect(() => {\n    const stateUpdate: Partial<VizPanelState> = {};\n\n    if (!prevProps) {\n      return;\n    }\n\n    if (title !== prevProps.title) {\n      stateUpdate.title = title;\n    }\n\n    if (description !== prevProps.description) {\n      stateUpdate.description = description;\n    }\n\n    if (displayMode !== prevProps.displayMode) {\n      stateUpdate.displayMode = displayMode;\n    }\n\n    if (hoverHeader !== prevProps.hoverHeader) {\n      stateUpdate.hoverHeader = hoverHeader;\n    }\n\n    if (hoverHeaderOffset !== prevProps.hoverHeaderOffset) {\n      stateUpdate.hoverHeaderOffset = hoverHeaderOffset;\n    }\n\n    if (menu !== prevProps.menu) {\n      stateUpdate.menu = menu;\n    }\n\n    if (titleItems !== prevProps.titleItems) {\n      stateUpdate.titleItems = titleItems;\n    }\n\n    if (headerActions !== prevProps.headerActions) {\n      stateUpdate.headerActions = headerActions;\n    }\n\n    if (dataProvider !== prevProps.dataProvider) {\n      stateUpdate.$data = getDataProviderForVizPanel(dataProvider);\n    }\n\n    if (seriesLimit !== prevProps.seriesLimit) {\n      stateUpdate.seriesLimit = seriesLimit;\n    }\n\n    if (seriesLimitShowAll !== prevProps.seriesLimitShowAll) {\n      stateUpdate.seriesLimitShowAll = seriesLimitShowAll;\n    }\n\n    if (collapsible !== prevProps.collapsible) {\n      stateUpdate.collapsible = collapsible;\n    }\n\n    if (collapsed !== prevProps.collapsed) {\n      stateUpdate.collapsed = collapsed;\n    }\n\n    if (viz !== prevProps.viz) {\n      if (viz.pluginId === prevProps.viz.pluginId) {\n        const plugin = panel.getPlugin();\n        if (plugin) {\n          const optionsWithDefaults = getPanelOptionsWithDefaults({\n            plugin,\n            currentOptions: viz.options,\n            currentFieldConfig: viz.fieldConfig,\n            isAfterPluginChange: false,\n          });\n          stateUpdate.options = optionsWithDefaults.options;\n          stateUpdate.fieldConfig = optionsWithDefaults.fieldConfig;\n\n          panel.clearFieldConfigCache();\n        }\n      }\n    }\n\n    if (Object.keys(stateUpdate).length > 0) {\n      panel.setState(stateUpdate);\n      writeSceneLog('VizPanel', 'Updating VizPanel state', stateUpdate);\n    }\n  }, [\n    panel,\n    title,\n    description,\n    displayMode,\n    hoverHeader,\n    hoverHeaderOffset,\n    headerActions,\n    menu,\n    titleItems,\n    viz,\n    dataProvider,\n    seriesLimit,\n    seriesLimitShowAll,\n    collapsible,\n    collapsed,\n    prevProps,\n  ]);\n\n  return <panel.Component model={panel} />;\n}\n\n/**\n * Since the useQueryRunner attaches query runners to the scene context their parent is already set\n * This proxy is to work around that.\n * TODO: Figure out a better way to handle this'\n */\nfunction getDataProviderForVizPanel(data: SceneDataProvider | undefined): SceneDataProvider | undefined {\n  if (data && !(data instanceof SceneDataNode)) {\n    return new DataProviderProxy({ source: data.getRef() });\n  }\n  return data;\n}\n"],"names":["VizPanelObject"],"mappings":"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"}