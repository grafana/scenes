{"version":3,"file":"VizPanel.js","sources":["../../../src/components/VizPanel.tsx"],"sourcesContent":["import React, { useEffect, useId } from 'react';\nimport {\n  SceneDataProvider,\n  VizPanel as VizPanelObject,\n  VizPanelState,\n  VizConfig,\n  DataProviderProxy,\n  SceneDataNode,\n} from '@grafana/scenes';\nimport { usePrevious } from 'react-use';\nimport { getPanelOptionsWithDefaults } from '@grafana/data';\nimport { writeSceneLog } from '../utils';\nimport { useSceneContext } from '../hooks/hooks';\n\nexport interface VizPanelProps {\n  title: string;\n  dataProvider?: SceneDataProvider;\n  viz: VizConfig;\n  headerActions?: React.ReactNode;\n}\n\nexport function VizPanel(props: VizPanelProps) {\n  const { title, viz, dataProvider, headerActions } = props;\n  const scene = useSceneContext();\n  const key = useId();\n  const prevProps = usePrevious(props);\n\n  let panel = scene.findByKey<VizPanelObject>(key);\n\n  if (!panel) {\n    panel = new VizPanelObject({\n      key: key,\n      title: title,\n      pluginId: viz.pluginId,\n      pluginVersion: viz.pluginVersion,\n      options: viz.options,\n      fieldConfig: viz.fieldConfig,\n      $data: getDataProviderForVizPanel(dataProvider),\n      headerActions: headerActions,\n    });\n  }\n\n  useEffect(() => scene.addToScene(panel), [panel, scene]);\n\n  // Update options\n  useEffect(() => {\n    const stateUpdate: Partial<VizPanelState> = {};\n\n    if (!prevProps) {\n      return;\n    }\n\n    if (title !== prevProps.title) {\n      stateUpdate.title = title;\n    }\n\n    if (headerActions !== prevProps.headerActions) {\n      stateUpdate.headerActions = headerActions;\n    }\n\n    if (dataProvider !== prevProps.dataProvider) {\n      stateUpdate.$data = getDataProviderForVizPanel(dataProvider);\n    }\n\n    if (viz !== prevProps.viz) {\n      if (viz.pluginId === prevProps.viz.pluginId) {\n        const plugin = panel.getPlugin();\n        if (plugin) {\n          const optionsWithDefaults = getPanelOptionsWithDefaults({\n            plugin,\n            currentOptions: viz.options,\n            currentFieldConfig: viz.fieldConfig,\n            isAfterPluginChange: false,\n          });\n          stateUpdate.options = optionsWithDefaults.options;\n          stateUpdate.fieldConfig = optionsWithDefaults.fieldConfig;\n\n          panel.clearFieldConfigCache();\n        }\n      }\n    }\n\n    if (Object.keys(stateUpdate).length > 0) {\n      panel.setState(stateUpdate);\n      writeSceneLog('VizPanel', 'Updating VizPanel state', stateUpdate);\n    }\n  }, [panel, title, headerActions, viz, dataProvider, prevProps]);\n\n  return <panel.Component model={panel} />;\n}\n\n/**\n * Since the useQueryRunner attaches query runners to the scene context their parent is already set\n * This proxy is to work around that.\n * TODO: Figure out a better way to handle this'\n */\nfunction getDataProviderForVizPanel(data: SceneDataProvider | undefined): SceneDataProvider | undefined {\n  if (data && !(data instanceof SceneDataNode)) {\n    return new DataProviderProxy({ source: data.getRef() });\n  }\n  return data;\n}\n"],"names":["VizPanelObject"],"mappings":"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"}