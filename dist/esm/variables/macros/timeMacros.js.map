{"version":3,"file":"timeMacros.js","sources":["../../../../src/variables/macros/timeMacros.ts"],"sourcesContent":["import { dateTimeFormat, urlUtil } from '@grafana/data';\nimport { getTimeRange } from '../../core/sceneGraph/getTimeRange';\nimport { getData } from '../../core/sceneGraph/sceneGraph';\nimport { SceneObject } from '../../core/types';\nimport { FormatVariable } from '../interpolation/formatRegistry';\nimport { SkipFormattingValue } from './types';\n\n/**\n * Handles expressions like $__url_time_range.\n */\nexport class UrlTimeRangeMacro implements FormatVariable {\n  public state: { name: string; type: string };\n  private _sceneObject: SceneObject;\n\n  public constructor(name: string, sceneObject: SceneObject) {\n    this.state = { name: name, type: 'url_variable' };\n    this._sceneObject = sceneObject;\n  }\n\n  public getValue(): SkipFormattingValue {\n    const timeRange = getTimeRange(this._sceneObject);\n    const urlState = timeRange.urlSync?.getUrlState();\n    return new SkipFormattingValue(urlUtil.toUrlParams(urlState));\n  }\n\n  public getValueText?(): string {\n    return '';\n  }\n}\n\n/**\n * Handles expressions like $__from and $__to.\n */\nexport class TimeFromAndToMacro implements FormatVariable {\n  public state: { name: string; type: string };\n  private _sceneObject: SceneObject;\n\n  public constructor(name: string, sceneObject: SceneObject) {\n    this.state = { name: name, type: 'time_macro' };\n    this._sceneObject = sceneObject;\n  }\n\n  public getValue() {\n    const timeRange = getTimeRange(this._sceneObject);\n    if (this.state.name === '__from') {\n      return timeRange.state.value.from.valueOf();\n    } else {\n      return timeRange.state.value.to.valueOf();\n    }\n  }\n\n  public getValueText?(): string {\n    const timeRange = getTimeRange(this._sceneObject);\n    if (this.state.name === '__from') {\n      return dateTimeFormat(timeRange.state.value.from, { timeZone: timeRange.getTimeZone() });\n    } else {\n      return dateTimeFormat(timeRange.state.value.to, { timeZone: timeRange.getTimeZone() });\n    }\n  }\n}\n\n/**\n * Handles $__timezone expression.\n */\nexport class TimezoneMacro implements FormatVariable {\n  public state: { name: string; type: string };\n  private _sceneObject: SceneObject;\n\n  public constructor(name: string, sceneObject: SceneObject) {\n    this.state = { name: name, type: 'time_macro' };\n    this._sceneObject = sceneObject;\n  }\n\n  public getValue() {\n    const timeRange = getTimeRange(this._sceneObject);\n    const timeZone = timeRange.getTimeZone();\n\n    if (timeZone === 'browser') {\n      return Intl.DateTimeFormat().resolvedOptions().timeZone;\n    }\n\n    return timeZone;\n  }\n\n  public getValueText?(): string {\n    return this.getValue();\n  }\n}\n\n/**\n * Handles $__interval and $__intervalMs expression.\n */\nexport class IntervalMacro implements FormatVariable {\n  public state: { name: string; type: string; match: string };\n  private _sceneObject: SceneObject;\n\n  public constructor(name: string, sceneObject: SceneObject, match: string) {\n    this.state = { name: name, type: 'time_macro', match: match };\n    this._sceneObject = sceneObject;\n  }\n\n  public getValue() {\n    const data = getData(this._sceneObject);\n\n    if (data) {\n      const request = data.state.data?.request;\n      if (!request) {\n        return this.state.match;\n      }\n      if (this.state.name === '__interval_ms') {\n        return request.intervalMs;\n      }\n      return request.interval;\n    }\n\n    return this.state.match;\n  }\n}\n"],"names":[],"mappings":"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"}