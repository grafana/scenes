{"version":3,"file":"utils.js","sources":["../../../../../src/variables/adhoc/AdHocFiltersCombobox/utils.ts"],"sourcesContent":["import { SelectableValue } from '@grafana/data';\nimport uFuzzy from '@leeoniya/ufuzzy';\nimport { AdHocInputType } from './AdHocFiltersCombobox';\nimport { AdHocFilterWithLabels, isMultiValueOperator } from '../AdHocFiltersVariable';\n\nconst VIRTUAL_LIST_WIDTH_ESTIMATE_MULTIPLIER = 8;\nconst VIRTUAL_LIST_DESCRIPTION_WIDTH_ESTIMATE_MULTIPLIER = 6;\nconst VIRTUAL_LIST_PADDING = 8;\nexport const VIRTUAL_LIST_OVERSCAN = 5;\nexport const VIRTUAL_LIST_ITEM_HEIGHT = 38;\nexport const VIRTUAL_LIST_ITEM_HEIGHT_WITH_DESCRIPTION = 60;\nexport const ERROR_STATE_DROPDOWN_WIDTH = 366;\n\nexport function fuzzySearchOptions(options: Array<SelectableValue<string>>) {\n  const ufuzzy = new uFuzzy();\n  const haystack: string[] = [];\n  const limit = 10000;\n\n  return (search: string, filterInputType: AdHocInputType) => {\n    if (search === '') {\n      if (options.length > limit) {\n        return options.slice(0, limit);\n      } else {\n        return options;\n      }\n    }\n\n    if (filterInputType === 'operator') {\n      const filteredOperators = [];\n      for (let i = 0; i < options.length; i++) {\n        if ((options[i].label || options[i].value)?.includes(search)) {\n          filteredOperators.push(options[i]);\n          if (filteredOperators.length > limit) {\n            return filteredOperators;\n          }\n        }\n      }\n      return filteredOperators;\n    }\n\n    if (haystack.length === 0) {\n      for (let i = 0; i < options.length; i++) {\n        haystack.push(options[i].label || options[i].value!);\n      }\n    }\n    const [idxs, info, order] = ufuzzy.search(haystack, search);\n    const filteredOptions: Array<SelectableValue<string>> = [];\n\n    if (idxs) {\n      for (let i = 0; i < idxs.length; i++) {\n        if (info && order) {\n          const idx = order[i];\n          filteredOptions.push(options[idxs[idx]]);\n        } else {\n          filteredOptions.push(options[idxs[i]]);\n        }\n\n        if (filteredOptions.length > limit) {\n          return filteredOptions;\n        }\n      }\n      return filteredOptions;\n    }\n\n    if (options.length > limit) {\n      return options.slice(0, limit);\n    }\n\n    return options;\n  };\n}\nexport const flattenOptionGroups = (options: Array<SelectableValue<string>>) =>\n  options.flatMap<SelectableValue<string>>((option) => (option.options ? [option, ...option.options] : [option]));\n\nexport const setupDropdownAccessibility = (\n  options: Array<SelectableValue<string>>,\n  listRef: React.MutableRefObject<Array<HTMLElement | null>>,\n  disabledIndicesRef: React.MutableRefObject<number[]>\n) => {\n  let maxOptionWidth = 182;\n  const listRefArr = [];\n  const disabledIndices = [];\n\n  for (let i = 0; i < options.length; i++) {\n    // listRefArr should be filled with nulls for amount of dropdown items so that\n    //    useNavigationList sets activeIndex correctly when navigating with arrow keys\n    listRefArr.push(null);\n\n    // disabledIndices are used to skip unselectable group items in dropdown when\n    //    navigating with arrow keys\n    if (options[i]?.options) {\n      disabledIndices.push(i);\n    }\n    let label = options[i].label ?? options[i].value ?? '';\n    let multiplierToUse = VIRTUAL_LIST_WIDTH_ESTIMATE_MULTIPLIER;\n    if (\n      label.length * VIRTUAL_LIST_WIDTH_ESTIMATE_MULTIPLIER <\n      (options[i].description?.length || 0) * VIRTUAL_LIST_DESCRIPTION_WIDTH_ESTIMATE_MULTIPLIER\n    ) {\n      label = options[i].description!;\n      multiplierToUse = VIRTUAL_LIST_DESCRIPTION_WIDTH_ESTIMATE_MULTIPLIER;\n    }\n\n    // rough widthEstimate\n    const widthEstimate =\n      (options[i].isCustom ? label.length + 18 : label.length) * multiplierToUse + VIRTUAL_LIST_PADDING * 2;\n    if (widthEstimate > maxOptionWidth) {\n      maxOptionWidth = widthEstimate;\n    }\n  }\n\n  listRef.current = [...listRefArr];\n  disabledIndicesRef.current = [...disabledIndices];\n  return maxOptionWidth;\n};\n\nconst nextInputTypeMap = {\n  key: 'operator',\n  operator: 'value',\n  value: 'key',\n} as const;\n\nexport const switchToNextInputType = (\n  filterInputType: AdHocInputType,\n  setInputType: React.Dispatch<React.SetStateAction<AdHocInputType>>,\n  handleChangeViewMode: (() => void) | undefined,\n  element: HTMLInputElement | null\n) =>\n  switchInputType(\n    nextInputTypeMap[filterInputType],\n    setInputType,\n    filterInputType === 'value' ? handleChangeViewMode : undefined,\n    element\n  );\n\nexport const switchInputType = (\n  filterInputType: AdHocInputType,\n  setInputType: React.Dispatch<React.SetStateAction<AdHocInputType>>,\n  handleChangeViewMode?: () => void,\n  element?: HTMLInputElement | null\n) => {\n  setInputType(filterInputType);\n\n  handleChangeViewMode?.();\n\n  setTimeout(() => element?.focus());\n};\n\nexport const generateFilterUpdatePayload = ({\n  filterInputType,\n  item,\n  filter,\n  setFilterMultiValues,\n}: {\n  filterInputType: AdHocInputType;\n  item: SelectableValue<string>;\n  filter: AdHocFilterWithLabels;\n  setFilterMultiValues: (value: React.SetStateAction<Array<SelectableValue<string>>>) => void;\n}): Partial<AdHocFilterWithLabels> => {\n  if (filterInputType === 'key') {\n    return {\n      key: item.value,\n      keyLabel: item.label ? item.label : item.value,\n    };\n  }\n  if (filterInputType === 'value') {\n    return {\n      value: item.value,\n      valueLabels: [item.label ? item.label : item.value!],\n    };\n  }\n\n  if (filterInputType === 'operator') {\n    // handle values/valueLabels when switching from multi to single value operator\n    if (isMultiValueOperator(filter.operator) && !isMultiValueOperator(item.value!)) {\n      // reset local multi values state\n      setFilterMultiValues([]);\n      // update operator and reset values and valueLabels\n      return {\n        operator: item.value,\n        // TODO remove when we're on the latest version of @grafana/data\n        //@ts-expect-error\n        valueLabels: [filter.valueLabels?.[0] || filter.values?.[0] || filter.value],\n        //@ts-expect-error\n        values: undefined,\n      };\n    }\n\n    // handle values/valueLabels when switching from single to multi value operator\n    if (isMultiValueOperator(item.value!) && !isMultiValueOperator(filter.operator)) {\n      // TODO remove when we're on the latest version of @grafana/data\n      //@ts-expect-error\n      const valueLabels = [filter.valueLabels?.[0] || filter.values?.[0] || filter.value];\n      const values = [filter.value];\n\n      // populate local multi values state\n      if (values[0]) {\n        setFilterMultiValues([\n          {\n            value: values[0],\n            label: valueLabels?.[0] ?? values[0],\n          },\n        ]);\n      }\n\n      // update operator and default values and valueLabels\n      return {\n        operator: item.value,\n        valueLabels: valueLabels,\n        //@ts-expect-error\n        values: values,\n      };\n    }\n  }\n\n  // default operator update of same multi/single type\n  return {\n    [filterInputType]: item.value,\n  };\n};\n\nconst INPUT_PLACEHOLDER = 'Filter by label values';\n\nexport const generatePlaceholder = (\n  filter: AdHocFilterWithLabels,\n  filterInputType: AdHocInputType,\n  isMultiValueEdit: boolean,\n  isAlwaysWip?: boolean\n) => {\n  if (filterInputType === 'key') {\n    return INPUT_PLACEHOLDER;\n  }\n  if (filterInputType === 'value') {\n    if (isMultiValueEdit) {\n      return 'Edit values';\n    }\n    return filter.valueLabels?.[0] || '';\n  }\n\n  return filter[filterInputType] && !isAlwaysWip ? `${filter[filterInputType]}` : INPUT_PLACEHOLDER;\n};\n"],"names":[],"mappings":"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"}