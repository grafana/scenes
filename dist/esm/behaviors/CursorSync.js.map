{"version":3,"file":"CursorSync.js","sources":["../../../src/behaviors/CursorSync.ts"],"sourcesContent":["import { BusEvent, BusEventHandler, BusEventType, EventBus, EventFilterOptions } from '@grafana/data';\nimport { DashboardCursorSync } from '@grafana/schema';\nimport { Observable, Unsubscribable } from 'rxjs';\nimport { sceneGraph } from '../core/sceneGraph';\nimport { SceneObjectBase } from '../core/SceneObjectBase';\nimport { SceneObject, SceneObjectState } from '../core/types';\n\ninterface CursorSyncState extends SceneObjectState {\n  sync: DashboardCursorSync;\n}\n\n/**\n * This behavior will provide a cursor sync context within a scene.\n */\n\nexport class CursorSync extends SceneObjectBase<CursorSyncState> {\n  public constructor(state: Partial<CursorSyncState>) {\n    super({\n      ...state,\n      sync: state.sync || DashboardCursorSync.Off,\n    });\n  }\n\n  public getEventsBus = (panel: SceneObject) => {\n    if (!this.parent) {\n      throw new Error('EnableCursorSync cannot be used as a standalone scene object');\n    }\n    // Since EnableCursorSync is a behavior, it is not a parent to any object in the scene graph.\n    // We need to get it's parent in order to provide correct EventBus context to the children.\n    return new PanelContextEventBus(this.parent, panel);\n  };\n\n  public getEventsScope() {\n    if (!this.parent) {\n      throw new Error('EnableCursorSync cannot be used as a standalone scene object');\n    }\n\n    // Since EnableCursorSync is a behavior, it is not a parent to any object in the scene graph.\n    // We need to get it's parent in order to provide correct EventBus context to the children.\n    return this.state.key!;\n  }\n}\n\n// This serves as a shared EventsBus that is shared by children or CursorSync behavior.\nclass PanelContextEventBus implements EventBus {\n  public constructor(private _source: SceneObject, private _eventsOrigin: SceneObject) {}\n\n  public publish<T extends BusEvent>(event: T): void {\n    (event as any).origin = this;\n    this._eventsOrigin.publishEvent(event, true);\n  }\n\n  public getStream<T extends BusEvent>(eventType: BusEventType<T>): Observable<T> {\n    return new Observable<T>((observer) => {\n      const handler = (event: T) => {\n        observer.next(event);\n      };\n\n      const sub = this._source.subscribeToEvent(eventType, handler);\n\n      return () => sub.unsubscribe();\n    });\n  }\n\n  public subscribe<T extends BusEvent>(eventType: BusEventType<T>, handler: BusEventHandler<T>): Unsubscribable {\n    return this.getStream(eventType).pipe().subscribe(handler);\n  }\n\n  public removeAllListeners(): void {}\n\n  public newScopedBus(key: string, filter: EventFilterOptions): EventBus {\n    throw new Error('For internal use only');\n  }\n}\n\nexport function getCursorSyncScope(sceneObject: SceneObject): CursorSync | null {\n  return sceneGraph.findObject(sceneObject, (o) => o instanceof CursorSync) as CursorSync;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAeO,MAAM,mBAAmB,eAAiC,CAAA;AAAA,EACxD,YAAY,KAAiC,EAAA;AAClD,IAAA,KAAA,CAAM,iCACD,KADC,CAAA,EAAA;AAAA,MAEJ,IAAA,EAAM,KAAM,CAAA,IAAA,IAAQ,mBAAoB,CAAA,GAAA;AAAA,KACzC,CAAA,CAAA,CAAA;AAGH,IAAO,IAAA,CAAA,YAAA,GAAe,CAAC,KAAuB,KAAA;AAC5C,MAAI,IAAA,CAAC,KAAK,MAAQ,EAAA;AAChB,QAAM,MAAA,IAAI,MAAM,8DAA8D,CAAA,CAAA;AAAA,OAChF;AAGA,MAAA,OAAO,IAAI,oBAAA,CAAqB,IAAK,CAAA,MAAA,EAAQ,KAAK,CAAA,CAAA;AAAA,KACpD,CAAA;AAAA,GATA;AAAA,EAWO,cAAiB,GAAA;AACtB,IAAI,IAAA,CAAC,KAAK,MAAQ,EAAA;AAChB,MAAM,MAAA,IAAI,MAAM,8DAA8D,CAAA,CAAA;AAAA,KAChF;AAIA,IAAA,OAAO,KAAK,KAAM,CAAA,GAAA,CAAA;AAAA,GACpB;AACF,CAAA;AAGA,MAAM,oBAAyC,CAAA;AAAA,EACtC,WAAA,CAAoB,SAA8B,aAA4B,EAAA;AAA1D,IAAA,IAAA,CAAA,OAAA,GAAA,OAAA,CAAA;AAA8B,IAAA,IAAA,CAAA,aAAA,GAAA,aAAA,CAAA;AAAA,GAA6B;AAAA,EAE/E,QAA4B,KAAgB,EAAA;AACjD,IAAC,MAAc,MAAS,GAAA,IAAA,CAAA;AACxB,IAAK,IAAA,CAAA,aAAA,CAAc,YAAa,CAAA,KAAA,EAAO,IAAI,CAAA,CAAA;AAAA,GAC7C;AAAA,EAEO,UAA8B,SAA2C,EAAA;AAC9E,IAAO,OAAA,IAAI,UAAc,CAAA,CAAC,QAAa,KAAA;AACrC,MAAM,MAAA,OAAA,GAAU,CAAC,KAAa,KAAA;AAC5B,QAAA,QAAA,CAAS,KAAK,KAAK,CAAA,CAAA;AAAA,OACrB,CAAA;AAEA,MAAA,MAAM,GAAM,GAAA,IAAA,CAAK,OAAQ,CAAA,gBAAA,CAAiB,WAAW,OAAO,CAAA,CAAA;AAE5D,MAAO,OAAA,MAAM,IAAI,WAAY,EAAA,CAAA;AAAA,KAC9B,CAAA,CAAA;AAAA,GACH;AAAA,EAEO,SAAA,CAA8B,WAA4B,OAA6C,EAAA;AAC5G,IAAA,OAAO,KAAK,SAAU,CAAA,SAAS,EAAE,IAAK,EAAA,CAAE,UAAU,OAAO,CAAA,CAAA;AAAA,GAC3D;AAAA,EAEO,kBAA2B,GAAA;AAAA,GAAC;AAAA,EAE5B,YAAA,CAAa,KAAa,MAAsC,EAAA;AACrE,IAAM,MAAA,IAAI,MAAM,uBAAuB,CAAA,CAAA;AAAA,GACzC;AACF,CAAA;AAEO,SAAS,mBAAmB,WAA6C,EAAA;AAC9E,EAAA,OAAO,WAAW,UAAW,CAAA,WAAA,EAAa,CAAC,CAAA,KAAM,aAAa,UAAU,CAAA,CAAA;AAC1E;;;;"}